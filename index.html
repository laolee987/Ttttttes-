<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠ æ¸›ä¹˜é™¤ (çµ‚æ¥µç©©å®šç‰ˆ)</title>
    
    <!-- å¼•å…¥ Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- è¦–è¦ºé¢¨æ ¼ --- */
        :root {
            --primary: #4e54c8;
            --primary-dark: #3a4099;
            --accent: #ff6b6b;
            --gold: #f1c40f;
            --danger: #e74c3c;
            --info: #3498db;
            --bg-body: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #2d3436;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }
        .app-container { width: 100%; max-width: 450px; padding-bottom: 30px; }
        
        /* å¤§å»³èˆ‡è¼¸å…¥æ¡† */
        .lobby-box { margin-top: 10vh; text-align: center; padding: 20px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; color: #666; }
        .input-group input { 
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;
            text-align: center;
        }
        
        /* éŠæˆ²ä¸­æ¨™é ­ */
        .sticky-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 10px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee;
        }
        
        /* å¡ç‰‡ç‰¹æ•ˆ */
        .card {
            background: var(--card-bg); border-radius: 16px; padding: 20px; margin: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .card-frenzy-add { border: 2px solid var(--gold); box-shadow: 0 0 15px rgba(241,196,15,0.3); }
        .card-frenzy-sub { border: 2px solid var(--info); box-shadow: 0 0 15px rgba(52,152,219,0.3); }

        /* LCD è¢å¹• */
        .lcd-screen {
            background: #2d3436; color: #55efc4; padding: 15px 20px;
            text-align: right; margin: 0; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
            transition: background 0.3s;
        }
        .expr-line { display: block; font-family: 'Courier New', monospace; font-size: 1rem; opacity: 0.8; word-break: break-all; }
        .result-line { display: block; font-size: 2.2rem; font-weight: bold; line-height: 1.2; }

        /* ç©å®¶èˆ‡æŒ‰éˆ• */
        .player-badge {
            background: var(--primary); color: white; padding: 5px 12px;
            border-radius: 20px; font-size: 0.9rem; font-weight: bold;
        }
        .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left:5px; font-weight:bold; }
        .st-fire { background: #ffeaa7; color: #d35400; border: 1px solid #f39c12; }
        
        .op-row { display: flex; justify-content: space-around; margin-bottom: 20px; margin-top: 15px;}
        .op-btn {
            width: 50px; height: 50px; border-radius: 50%; border: 1px solid #e0e0e0;
            background: #fff; font-size: 1.4rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; user-select: none;
        }
        .op-btn.selected { background: var(--primary); color: white; transform: scale(1.15); box-shadow: 0 5px 15px rgba(78,84,200,0.3); }
        .op-btn.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        
        .op-btn.bonus-double { border-color: var(--gold); color: #d35400; font-weight:bold; }
        .op-btn.selected.bonus-double { background: var(--gold); color: white; }
        
        .action-btn {
            width: 100%; padding: 16px; background: var(--primary); color: white;
            font-size: 1.2rem; font-weight: bold; border: none; border-radius: 12px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .action-btn:disabled { 
            background: #ccc !important; color: #888 !important;
            cursor: not-allowed; box-shadow: none; transform: none !important;
        }
        .action-btn.bonus-btn { background: linear-gradient(135deg, #f1c40f 0%, #d35400 100%); }

        .hidden { display: none !important; }
        
        /* éª°å­å‹•ç•« */
        #dice-container {
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .dice-box {
            width: 60px; height: 60px; background: white;
            border: 3px solid #2d3436; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; font-weight: bold;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.8);
        }

        .rolling {
            animation: shake 0.2s infinite;
            background: #ffeaa7 !important;
        }
        
        .dice-finished {
            background: #fffa65 !important;
            transform: scale(1.1);
            transition: transform 0.2s;
        }

        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }

        #wait-msg { color: #e74c3c; font-weight: bold; text-align: center; margin-top: 10px; display: none; }
        
        /* ç©å®¶åˆ—è¡¨ */
        .player-list { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;}
        .p-slot { padding: 5px 10px; background: #eee; border-radius: 15px; font-size: 0.8rem; }
        .p-slot.active { background: #55efc4; color: #000; font-weight: bold; border: 1px solid #00b894; }
        .p-slot.current-turn { border: 2px solid var(--primary); background: #fff; box-shadow: 0 0 5px var(--primary); }

        #emergency-reset {
            display: none; width: 100%; margin-top: 10px;
            background: #e74c3c; color: white; border: none; padding: 10px;
            border-radius: 8px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <!-- 1. å¤§å»³ç•«é¢ -->
    <div id="lobby-screen" class="lobby-box">
        <div class="card">
            <h1 style="color:var(--primary)">ğŸ² æš´èµ°é‹ç®— (ç©©å®šç‰ˆ)</h1>
            <div class="input-group">
                <label>ä½ çš„åå­— / æš±ç¨±</label>
                <input type="text" id="my-name" placeholder="ä¾‹å¦‚: å°æ˜" maxlength="8">
            </div>
            <div class="input-group">
                <label>æˆ¿é–“è™Ÿç¢¼ (4ä½æ•¸)</label>
                <input type="number" id="room-id" placeholder="ä¾‹å¦‚: 8888" value="8888">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="action-btn" style="background:var(--info)" onclick="joinRoom('host')">å»ºç«‹æˆ¿é–“ (æˆ‘æ˜¯æˆ¿ä¸»)</button>
                <button class="action-btn" onclick="joinRoom('guest')">åŠ å…¥éŠæˆ²</button>
            </div>
            <p style="font-size:0.8rem; color:#888; margin-top:20px;">
                è¼¸å…¥ç›¸åŒæˆ¿è™Ÿå³å¯é€£ç·šã€‚<br>
                ä¿®å¾©äº†å‹•ç•«å¡ä½çš„å•é¡Œã€‚
            </p>
        </div>
    </div>

    <!-- 2. è¨­å®šç›®æ¨™ç•«é¢ (åªæœ‰æˆ¿ä¸»çœ‹å¾—åˆ°) -->
    <div id="setup-screen" class="lobby-box hidden">
        <div class="card">
            <h1>è¨­å®šç›®æ¨™</h1>
            <p>ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥ä¸­...</p>
            <div id="lobby-players" class="player-list"></div>
            <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">
            <p>è¨­å®šæœ¬å±€ç›®æ¨™æ•¸å­—:</p>
            <input type="number" id="target-input" value="2486" style="padding:10px; font-size:1.5rem; width:100%; text-align:center; margin-bottom:20px;">
            <button class="action-btn" onclick="hostStartGame()">é–‹å§‹å°æˆ°</button>
        </div>
    </div>

    <!-- 3. ç­‰å¾…é–‹å§‹ç•«é¢ (å®¢ç«¯) -->
    <div id="wait-start-screen" class="lobby-box hidden">
        <div class="card">
            <h2>â³ ç­‰å¾…æˆ¿ä¸»é–‹å§‹</h2>
            <p>æˆ¿è™Ÿ: <span id="wait-room-id" style="font-weight:bold; color:var(--primary)"></span></p>
            <p>ç›®å‰é€£ç·šç©å®¶:</p>
            <div id="wait-players" class="player-list"></div>
        </div>
    </div>

    <!-- 4. éŠæˆ²ä¸»ç•«é¢ -->
    <div id="game-screen" class="hidden">
        <!-- é™¤éŒ¯è³‡è¨Šæ¬„ -->
        <div style="font-size:0.7rem; color:#888; text-align:center; background:#eee; padding:2px;">
            Status: <span id="debug-info">æº–å‚™ä¸­...</span>
        </div>

        <div class="sticky-header">
            <div style="display:flex; flex-direction:column;">
                <span style="font-size:0.8rem; color:#888;">Target</span>
                <span style="font-size:1.4rem; font-weight:800; color:var(--primary)" id="target-display">0</span>
            </div>
            <div style="text-align:right;">
                <span style="font-size:0.8rem; color:#888;">Round</span><br>
                <span id="round-display" style="font-weight:bold;">1 / 15</span>
            </div>
        </div>

        <div class="lcd-screen" id="lcd-bg">
            <span class="expr-line" id="expression-display">0</span>
            <span class="result-line" id="current-eval-lcd">0</span>
        </div>

        <!-- ç‹€æ…‹èˆ‡ç©å®¶åˆ—è¡¨ -->
        <div style="padding: 10px 15px;">
            <div id="status-badges" style="display:flex; gap:5px; justify-content:center; margin-bottom:5px;"></div>
            <div id="ingame-players" class="player-list"></div>
        </div>

        <div class="card" id="turn-ui">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span id="current-player-name" class="player-badge">ç­‰å¾…ä¸­...</span>
                <span id="op-hint" style="font-size:0.8rem; color:#999;"></span>
            </div>

            <input type="number" id="player-num-input" placeholder="é»æˆ‘è¼¸å…¥æ•¸å­—" 
                   style="width:100%; padding:15px; font-size:1.5rem; text-align:center; border:2px solid #eee; border-radius:10px; margin-bottom:10px; background: #fff;">

            <div id="op-buttons-container" class="op-row"></div>

            <!-- éª°å­å€åŸŸ -->
            <div id="dice-container" class="hidden">
                <div id="dice-visual-1" class="dice-box">?</div>
                <div id="dice-visual-2" class="dice-box hidden">?</div>
            </div>

            <button id="submit-btn" class="action-btn" disabled onclick="handleRollClick()">ç­‰å¾…å…¶ä»–ç©å®¶...</button>
            
            <button id="emergency-reset" onclick="forceResetState()">âš ï¸ å¡ä½äº†ï¼Ÿé»æˆ‘é‡ç½®</button>
        </div>

        <div class="card" style="background:#f9f9f9; padding:10px;">
            <div style="font-size:0.8rem; font-weight:bold; color:#555; margin-bottom:5px;">ğŸ“œ æˆ°æ³é€Ÿå ±</div>
            <div id="game-log" style="height:100px; overflow-y:auto; font-size:0.85rem; color:#666;"></div>
        </div>
    </div>
    
    <!-- 5. çµç®—ç•«é¢ -->
    <div id="result-screen" class="hidden lobby-box">
        <div class="card">
            <h2>ğŸ† éŠæˆ²çµæŸ</h2>
            <p>æœ€çµ‚çµæœ: <span id="final-value" style="font-size:2rem; font-weight:bold; color:var(--primary)">0</span></p>
            <div id="winner-announce" style="font-size:1.5rem; font-weight:bold; margin:20px 0;"></div>
            <button class="action-btn" onclick="location.reload()">å›åˆ°å¤§å»³</button>
        </div>
    </div>

</div>

<script>
    // =========================================================
    // 1. Firebase åˆå§‹åŒ–
    // =========================================================
    const firebaseConfig = {
      apiKey: "AIzaSyBoGMRKvo1WpVsjNCML6_KUpadao-4N6NY",
      authDomain: "mathgame-1e999.firebaseapp.com",
      databaseURL: "https://mathgame-1e999-default-rtdb.firebaseio.com",
      projectId: "mathgame-1e999",
      storageBucket: "mathgame-1e999.firebasestorage.app",
      messagingSenderId: "331451652458",
      appId: "1:331451652458:web:4d03fb4c08e2ca32206d13",
      measurementId: "G-5SN0H2HEF3"
    };

    if (!firebase.apps.length) {
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) {
            console.error(e);
            alert("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Config");
        }
    }
    const db = firebase.database();

    // =========================================================
    // 2. éŸ³æ•ˆç³»çµ±
    // =========================================================
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playDiceSound() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const bufferSize = audioCtx.sampleRate * 0.2; 
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        const gainNode = audioCtx.createGain();
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        noise.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        noise.start();
    }

    // =========================================================
    // 3. å…¨åŸŸè®Šæ•¸
    // =========================================================
    let myName = "";
    let roomId = "";
    let myPlayerIndex = -1;
    let localGameState = {};
    let animationInterval = null;
    let animTimeout = null;
    const totalRounds = 15;
    const ANIMATION_DURATION = 1500; // 1.5ç§’å‹•ç•«

    // =========================================================
    // 4. é€£ç·šèˆ‡å¤§å»³é‚è¼¯
    // =========================================================
    function joinRoom(role) {
        myName = document.getElementById('my-name').value.trim();
        roomId = document.getElementById('room-id').value.trim();
        if (!myName || !roomId) return alert("è«‹è¼¸å…¥åå­—å’Œæˆ¿è™Ÿ");

        const roomRef = db.ref('rooms/' + roomId);

        if (role === 'host') {
            roomRef.set({
                status: 'setup',
                target: 2486,
                players: [myName],
                gameState: null,
                logs: {}
            }).then(() => enterSetupScreen());
        } else {
            roomRef.get().then(snapshot => {
                if (!snapshot.exists()) return alert("æˆ¿é–“ä¸å­˜åœ¨ (è«‹ç¢ºèªæˆ¿ä¸»å·²å»ºç«‹)");
                const data = snapshot.val();
                if (data.status !== 'setup') return alert("éŠæˆ²å·²é–‹å§‹ï¼Œç„¡æ³•åŠ å…¥");
                
                let currentPlayers = data.players || [];
                if (currentPlayers.length >= 4) return alert("æˆ¿é–“å·²æ»¿ (4äºº)");

                if (!currentPlayers.includes(myName)) {
                    currentPlayers.push(myName);
                    roomRef.update({ players: currentPlayers }).then(() => enterWaitScreen());
                } else {
                    enterWaitScreen();
                }
            });
        }
    }

    function enterSetupScreen() {
        document.getElementById('lobby-screen').classList.add('hidden');
        document.getElementById('setup-screen').classList.remove('hidden');
        db.ref(`rooms/${roomId}/players`).on('value', snap => renderPlayerList(snap.val(), 'lobby-players'));
    }

    function enterWaitScreen() {
        document.getElementById('lobby-screen').classList.add('hidden');
        document.getElementById('wait-start-screen').classList.remove('hidden');
        document.getElementById('wait-room-id').textContent = roomId;

        db.ref(`rooms/${roomId}/players`).on('value', snap => {
            const players = snap.val() || [];
            renderPlayerList(players, 'wait-players');
            myPlayerIndex = players.indexOf(myName);
        });

        db.ref(`rooms/${roomId}/status`).on('value', snap => {
            if (snap.val() === 'playing') startGameUI();
        });
    }

    function renderPlayerList(players, elementId) {
        const div = document.getElementById(elementId);
        div.innerHTML = '';
        if (!players) return;
        players.forEach((p, idx) => {
            const span = document.createElement('span');
            span.className = 'p-slot';
            span.textContent = `${idx+1}. ${p}`;
            if (p === myName) span.classList.add('active');
            div.appendChild(span);
        });
    }

    // =========================================================
    // 5. éŠæˆ²åˆå§‹åŒ–
    // =========================================================
    function hostStartGame() {
        const target = parseInt(document.getElementById('target-input').value);
        const initialState = {
            target: target,
            currentRound: 1,
            expression: "0",
            currentValue: 0,
            permanentBonusActive: false, 
            turnQueue: [], 
            currentTurnData: null,
            // é—œéµä¿®æ”¹ï¼šlastDice åŒ…å«æ™‚é–“æˆ³è¨˜ï¼Œåˆå§‹å€¼ç‚º 0
            lastDice: { d1: "?", d2: "?", timestamp: 0, useDouble: false },
            usedNumbers: [] 
        };

        initialState.turnQueue = generateTurnQueue(1);
        initialState.currentTurnData = initialState.turnQueue.shift();

        db.ref(`rooms/${roomId}/gameState`).set(initialState);
        db.ref(`rooms/${roomId}/status`).set('playing');
        startGameUI();
    }

    function generateTurnQueue(round) {
        let queue = [];
        let roleOrder, executeOrder, freeChoicePlayers;
        
        if (round % 2 !== 0) { // å¥‡æ•¸
            roleOrder = ['+', '-', '*', '/'];
            executeOrder = [0, 1, 2, 3];
            freeChoicePlayers = (round > 1) ? [0, 1] : [];
        } else { // å¶æ•¸
            roleOrder = ['/', '*', '-', '+'];
            executeOrder = [3, 2, 1, 0];
            freeChoicePlayers = [3, 2];
        }

        let pDefaultOp = {};
        executeOrder.forEach((pIdx, pos) => { pDefaultOp[pIdx] = roleOrder[pos]; });

        executeOrder.forEach((pIdx, pos) => {
            let myDefault = roleOrder[pos];
            let mateIdx = (pIdx + 2) % 4;
            let mateDefault = pDefaultOp[mateIdx];
            let canSwitch = freeChoicePlayers.includes(pIdx);
            
            queue.push({
                playerIdx: pIdx,
                defaultOp: myDefault,
                mateOp: mateDefault,
                canSwitch: canSwitch
            });
        });
        return queue;
    }

    // =========================================================
    // 6. éŠæˆ²åŒæ­¥èˆ‡æ¸²æŸ“ (æ”¹é€²ï¼šåŸºæ–¼æ™‚é–“æˆ³è¨˜çš„å‹•ç•«)
    // =========================================================
    function startGameUI() {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('wait-start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');

        db.ref(`rooms/${roomId}/gameState`).on('value', snap => {
            const state = snap.val();
            if (state) {
                localGameState = state;
                renderGame(state);
            }
        });
        
        db.ref(`rooms/${roomId}/logs`).on('child_added', snap => {
            const msg = snap.val();
            const logDiv = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.textContent = msg;
            entry.style.borderBottom = "1px solid #eee";
            entry.style.padding = "4px 0";
            logDiv.insertBefor