<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠ æ¸›ä¹˜é™¤ (éå°ç¨±æš´èµ°ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4e54c8;
            --primary-dark: #3a4099;
            --accent: #ff6b6b;
            --gold: #f1c40f;
            --danger: #e74c3c;
            --info: #3498db;
            --bg-body: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --lcd-bg: #2d3436;
            --lcd-text: #55efc4;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            padding-bottom: 30px;
        }

        /* --- Header --- */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 10px 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .header-item {
            display: flex;
            flex-direction: column;
        }

        .header-label {
            font-size: 0.75rem;
            color: var(--text-sub);
        }

        .header-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--primary);
        }

        .status-container {
            display: flex;
            gap: 5px;
        }

        .status-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        .st-fire {
            background: #ffeaa7;
            color: #d35400;
            border: 1px solid #f39c12;
        }

        .st-sleep {
            background: #dfe6e9;
            color: #636e72;
            border: 1px solid #b2bec3;
        }

        /* --- Cards --- */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: border 0.3s, box-shadow 0.3s;
        }

        /* åŠ ä¹˜æš´èµ°ç‰¹æ•ˆ */
        .card-frenzy-add {
            border: 2px solid var(--gold);
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.3);
        }

        /* æ¸›é™¤æš´èµ°ç‰¹æ•ˆ */
        .card-frenzy-sub {
            border: 2px solid var(--info);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
        }

        .hidden {
            display: none !important;
        }

        .setup-box {
            margin-top: 20vh;
            text-align: center;
        }

        .setup-box h1 {
            margin-bottom: 5px;
            color: var(--primary);
        }

        .setup-box p {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 30px;
        }

        /* --- LCD Screen --- */
        .lcd-screen {
            background: var(--lcd-bg);
            color: var(--lcd-text);
            padding: 15px 20px;
            margin: 0;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
            text-align: right;
            position: relative;
            transition: background-color 0.3s;
        }

        .game-lcd {
            width: 100%;
        }

        .expr-line {
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow-x: auto;
            margin-bottom: 5px;
            display: block;
        }

        .result-line {
            font-size: 2.2rem;
            font-weight: bold;
            display: block;
            line-height: 1.2;
        }

        /* --- UI Elements --- */
        .player-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-badge {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* ç‰¹æ®Šç‹€æ…‹æ¨™ç±¤ */
        .bonus-badge {
            color: white;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            margin-left: 8px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: none;
            animation: pulse 1.5s infinite;
        }

        /* åŠ ä¹˜éšŠé›™éª° */
        .badge-double {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            display: inline-block;
        }

        /* æ¸›é™¤éšŠè‡ªç”±é¸ */
        .badge-free {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            display: inline-block;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .op-hint {
            font-size: 0.8rem;
            color: #999;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }

        input[type="number"] {
            flex: 1;
            padding: 12px;
            font-size: 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            outline: none;
            appearance: textfield;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"]:focus {
            border-color: var(--primary);
            background: #fdfdff;
        }

        .used-nums-display {
            font-size: 0.85rem;
            color: #e74c3c;
            text-align: center;
            margin-bottom: 15px;
            min-height: 1.2em;
        }

        .op-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .op-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 1px solid #e0e0e0;
            background: #fff;
            color: #555;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .op-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.15);
            box-shadow: 0 4px 10px rgba(78, 84, 200, 0.3);
        }

        /* é›™éª°åŠ æˆæŒ‰éˆ• */
        .op-btn.selected.bonus-double {
            background: var(--gold);
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.6);
        }

        /* è‡ªç”±é¸åŠ æˆæŒ‰éˆ• */
        .op-btn.bonus-free {
            border-color: #3498db;
            color: #3498db;
            font-weight: bold;
        }

        .op-btn.selected.bonus-free {
            background: #3498db;
            color: white;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.6);
        }

        .action-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(78, 84, 200, 0.3);
            transition: background 0.3s;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-btn:disabled {
            background: #b2bec3;
            box-shadow: none;
        }

        .action-btn.bonus-btn {
            background: linear-gradient(135deg, #f1c40f 0%, #d35400 100%);
        }

        /* --- éª°å­å€åŸŸ --- */
        #dice-container {
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .dice-box {
            width: 60px;
            height: 60px;
            background: white;
            border: 3px solid var(--text-main);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.8);
        }

        .rolling {
            animation: shake 0.2s infinite;
            background: #ffeaa7 !important;
        }

        .dice-finished {
            background: #fffa65 !important;
            transform: scale(1.1);
        }

        @keyframes shake {
            0% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(5deg);
            }

            75% {
                transform: rotate(-5deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        /* --- Logs & Toast --- */
        .log-section {
            margin: 0 15px;
            border-radius: 12px;
            background: #eef2f5;
            overflow: hidden;
        }

        .log-header {
            padding: 12px 15px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .log-content {
            max-height: 0;
            overflow-y: auto;
            transition: max-height 0.3s ease-out;
            background: #fff;
        }

        .log-content.open {
            max-height: 200px;
        }

        .log-entry {
            padding: 8px 15px;
            font-size: 0.85rem;
            border-bottom: 1px solid #f0f0f0;
            color: #666;
        }

        .arrow-icon {
            transition: transform 0.3s;
            font-size: 0.8rem;
        }

        .open .arrow-icon {
            transform: rotate(180deg);
        }

        #toast-msg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 20px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            width: 80%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #toast-msg.show {
            opacity: 1;
        }

        .result-screen-content {
            padding: 20px;
            text-align: center;
        }

        .winner-text {
            font-size: 1.8rem;
            margin: 20px 0;
            font-weight: 800;
        }

        .result-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #eee;
        }

        .stat-title {
            font-size: 0.8rem;
            color: #888;
            display: block;
            margin-bottom: 5px;
        }

        .stat-num {
            font-size: 1.2rem;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="app-container">

        <div id="toast-msg"></div>

        <div id="setup-screen" class="setup-box">
            <div class="card">
                <h1>ğŸ² åŠ æ¸›ä¹˜é™¤</h1>
                <p>è¼¸å…¥ç›®æ¨™å››ä½æ•¸é–‹å§‹æŒ‘æˆ°</p>
                <input type="number" id="target-input" placeholder="ä¾‹å¦‚: 2486" value="2486" style="margin-bottom: 20px;">
                <button class="action-btn" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
            </div>
        </div>

        <div id="game-screen" class="hidden">

            <div class="sticky-header">
                <div class="header-item">
                    <span class="header-label">ç›®æ¨™ Target</span>
                    <span class="header-value" id="target-display">0</span>
                </div>
                <div class="header-item" style="align-items: flex-end;">
                    <span class="header-label">è¼ªæ¬¡ Round</span>
                    <div style="display:flex; flex-direction:column; align-items:flex-end;">
                        <span class="header-value" id="round-display">1 / 15</span>
                        <div id="status-badges" class="status-container"></div>
                    </div>
                </div>
            </div>

            <div class="lcd-screen game-lcd" id="lcd-bg">
                <span class="expr-line" id="expression-display">0</span>
                <span class="result-line" id="current-eval-lcd">0</span>
            </div>

            <div class="card" id="turn-ui">
                <div class="player-info-bar" id="player-badge-container">
                    <div>
                        <span id="current-player-name" class="player-badge">ç©å®¶ 1</span>
                        <span id="badge-double" class="bonus-badge badge-double">ğŸ”¥é›™éª°ç«åŠ›</span>
                        <span id="badge-free" class="bonus-badge badge-free">ğŸ”“è‡ªç”±é¸æ“‡</span>
                    </div>
                    <span id="op-hint" class="op-hint">é è¨­: +</span>
                </div>

                <div class="input-row">
                    <input type="number" id="player-num-input" placeholder="1-9" pattern="\d*" inputmode="numeric"
                        min="1" max="9">
                </div>

                <div id="used-nums-display" class="used-nums-display"></div>

                <div class="op-row" id="op-buttons-container">
                </div>

                <div id="dice-container" class="hidden">
                    <div id="dice-visual-1" class="dice-box">?</div>
                    <div id="dice-visual-2" class="dice-box hidden">?</div>
                </div>

                <button id="submit-btn" class="action-btn" onclick="startDiceAnimation()">æ“²éª°ä¸¦è¨ˆç®—</button>
            </div>

            <div class="log-section">
                <div class="log-header" onclick="toggleLog()">
                    <span>ğŸ“œ æˆ°æ³ç´€éŒ„</span>
                    <span class="arrow-icon">â–¼</span>
                </div>
                <div class="log-content" id="log-content-area">
                </div>
            </div>
        </div>

        <div id="result-screen" class="hidden">
            <div class="result-screen-content">
                <h2>éŠæˆ²çµæŸ</h2>

                <div class="card" style="background:#f9f9f9; text-align: right; margin: 0 0 20px 0;">
                    <span style="display:block; font-size:0.9rem; color:#888;">æœ€çµ‚ç®—å¼</span>
                    <span id="final-expression"
                        style="font-family:'Courier New'; display:block; word-break:break-all; margin-bottom:10px;"></span>
                    <span style="display:block; font-size:0.9rem; color:#888;">æœ€çµ‚çµæœ</span>
                    <span id="final-value" style="font-size:2rem; font-weight:bold; color:var(--primary);"></span>
                </div>

                <div id="winner-announce" class="winner-text"></div>

                <div class="result-stats">
                    <div class="stat-card" style="border-color: #ff6b6b;">
                        <span class="stat-title" style="color:#ff6b6b">åŠ ä¹˜éšŠ (è·ç›®æ¨™)</span>
                        <span class="stat-num" id="diff-target">0</span>
                    </div>
                    <div class="stat-card" style="border-color: #4e54c8;">
                        <span class="stat-title" style="color:#4e54c8">æ¸›é™¤éšŠ (è· 0)</span>
                        <span class="stat-num" id="diff-zero">0</span>
                    </div>
                </div>

                <button class="action-btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
            </div>
        </div>

    </div>

    <script>
        // --- éŸ³æ•ˆ ---
        const diceSound = new Audio('dice.mp3');

        // --- å…¨åŸŸè®Šæ•¸ ---
        let target = 0;
        let totalRounds = 15; // å›ºå®š 15 è¼ª
        let currentRound = 1;
        let expression = "0";
        let currentValue = 0;

        let turnQueue = [];
        let currentTurn = null;
        let usedNumbersInRound = [];

        // â˜… æš´èµ°æ¨¡å¼é–‹é—œ
        let permanentBonusActive = false;

        const players = ["ç©å®¶ 1", "ç©å®¶ 2", "ç©å®¶ 3", "ç©å®¶ 4"];
        const initialRoles = ['+', '-', '*', '/'];
        let diceInterval = null;

        // --- UI Helpers ---
        function toggleLog() {
            const content = document.getElementById('log-content-area');
            const header = document.querySelector('.log-section');
            content.classList.toggle('open');
            header.classList.toggle('open');
        }

        function log(msg) {
            const logArea = document.getElementById('log-content-area');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = msg;
            logArea.insertBefore(div, logArea.firstChild);
        }

        function updateUsedNumsUI() {
            const div = document.getElementById('used-nums-display');
            if (usedNumbersInRound.length === 0) {
                div.textContent = "";
            } else {
                div.textContent = "ğŸš« æœ¬è¼ªå·²é¸: " + usedNumbersInRound.join(", ");
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast-msg');
            toast.innerHTML = msg;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateRoundHeader() {
            document.getElementById('round-display').textContent = `${currentRound} / ${totalRounds}`;
            const container = document.getElementById('status-badges');
            container.innerHTML = '';

            if (permanentBonusActive) {
                // åŠ ä¹˜éšŠæ°¸ä¹…ç„¡CD
                const b1 = document.createElement('span');
                b1.className = "status-badge st-fire";
                b1.textContent = "ğŸ”¥åŠ ä¹˜æš´èµ°";
                container.appendChild(b1);

                // æ¸›é™¤éšŠå¶æ•¸è¼ªæœ‰æ•ˆ
                const isSubDivActive = (currentRound % 2 === 0);
                const b2 = document.createElement('span');
                if (isSubDivActive) {
                    b2.className = "status-badge st-fire";
                    b2.textContent = "ğŸ”¥æ¸›é™¤æš´èµ°";
                } else {
                    b2.className = "status-badge st-sleep";
                    b2.textContent = "ğŸ’¤æ¸›é™¤CD";
                }
                container.appendChild(b2);
            }
        }

        // --- Game Logic ---
        function roll() { return Math.floor(Math.random() * 6) + 1; }
        function teammateOf(idx) { return (idx + 2) % 4; }
        function safeEval(expr) {
            try {
                if (/[^0-9+\-*/().\s]/.test(expr)) return 0;
                return eval(expr);
            } catch (e) { return 0; }
        }

        function startGame() {
            const input = document.getElementById('target-input').value;
            if (!input) return alert("è«‹è¼¸å…¥ç›®æ¨™æ•¸å­—");
            target = parseInt(input);

            totalRounds = 15; // å›ºå®š

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');

            document.getElementById('target-display').textContent = target;

            log(`éŠæˆ²é–‹å§‹ï¼ç›®æ¨™: ${target}`);
            log(`è¦å‰‡: å›ºå®š 15 è¼ª`);

            expression = "0";
            currentValue = 0;
            currentRound = 1;
            permanentBonusActive = false;

            startRound();
        }

        function startRound() {
            if (currentRound > totalRounds) {
                endGame();
                return;
            }

            updateRoundHeader();
            log(`--- ç¬¬ ${currentRound} è¼ª ---`);

            usedNumbersInRound = [];
            updateUsedNumsUI();

            let roleOrder, executeOrder, freeChoicePlayers;

            if (currentRound % 2 !== 0) {
                roleOrder = [...initialRoles];
                executeOrder = [0, 1, 2, 3];
                freeChoicePlayers = (currentRound > 1) ? [0, 1] : [];
            } else {
                roleOrder = [...initialRoles].reverse();
                executeOrder = [3, 2, 1, 0];
                freeChoicePlayers = [3, 2];
            }

            turnQueue = [];
            let pDefaultOp = {};
            executeOrder.forEach((pIdx, pos) => {
                pDefaultOp[pIdx] = roleOrder[pos];
            });

            executeOrder.forEach((pIdx, pos) => {
                let myDefault = roleOrder[pos];
                let mateIdx = teammateOf(pIdx);
                let mateDefault = pDefaultOp[mateIdx];
                let canSwitch = freeChoicePlayers.includes(pIdx);

                turnQueue.push({
                    playerIdx: pIdx,
                    playerName: players[pIdx],
                    defaultOp: myDefault,
                    mateOp: mateDefault,
                    canSwitch: canSwitch
                });
            });

            nextTurn();
        }

        function nextTurn() {
            if (turnQueue.length === 0) {
                currentRound++;
                startRound();
                return;
            }

            currentTurn = turnQueue.shift();
            renderTurnUI();

            // é‡ç½®éª°å­é¡¯ç¤º
            document.getElementById('dice-container').classList.add('hidden');
            document.getElementById('dice-visual-1').className = 'dice-box';
            document.getElementById('dice-visual-1').textContent = '?';
            document.getElementById('dice-visual-2').className = 'dice-box hidden';
        }

        function renderTurnUI() {
            const pIdx = currentTurn.playerIdx;
            const pName = currentTurn.playerName;
            const defaultOp = currentTurn.defaultOp;
            const mateOp = currentTurn.mateOp;
            const canSwitch = currentTurn.canSwitch;

            document.getElementById('current-player-name').textContent = pName;
            const numInput = document.getElementById('player-num-input');
            numInput.value = "";

            // ä»‹é¢é‡ç½®
            const badgeDouble = document.getElementById('badge-double');
            const badgeFree = document.getElementById('badge-free');
            const card = document.getElementById('turn-ui');
            const submitBtn = document.getElementById('submit-btn');

            badgeDouble.style.display = 'none';
            badgeFree.style.display = 'none';
            card.className = "card"; // reset
            submitBtn.classList.remove('bonus-btn');

            const btnContainer = document.getElementById('op-buttons-container');
            btnContainer.innerHTML = '';
            const hintEl = document.getElementById('op-hint');

            let opsToShow = [defaultOp];
            let hintText = `é è¨­: ${defaultOp}`;

            if (canSwitch && mateOp && mateOp !== defaultOp) {
                opsToShow.push(mateOp);
                hintText = `å¯æ›: ${mateOp}`;
            }

            // --- â˜… åˆ†æµæš´èµ°æ¨¡å¼é‚è¼¯ ---
            let isAddMulTeam = (defaultOp === '+' || defaultOp === '*');
            let isSubDivTeam = (defaultOp === '-' || defaultOp === '/');

            // åŠ ä¹˜éšŠï¼šæ°¸ä¹…æš´èµ°
            let frenzyAddMul = permanentBonusActive;

            // æ¸›é™¤éšŠï¼šå¶æ•¸è¼ªæœ‰æ•ˆ
            let frenzySubDiv = permanentBonusActive && (currentRound % 2 === 0);

            if (frenzyAddMul && isAddMulTeam) {
                card.classList.add('card-frenzy-add');
                badgeDouble.style.display = 'inline-block';
                submitBtn.classList.add('bonus-btn');
            }
            else if (frenzySubDiv && isSubDivTeam) {
                card.classList.add('card-frenzy-sub');
                badgeFree.style.display = 'inline-block';
                // å¼·åˆ¶åŠ å…¥ - å’Œ /
                if (!opsToShow.includes('-')) opsToShow.push('-');
                if (!opsToShow.includes('/')) opsToShow.push('/');
                hintText = "æš´èµ°ä¸­: è‡ªç”±åˆ‡æ›";
            }

            // --- 0åˆ†ç‰¹æ¬Š (ä¿ç•™) ---
            if (currentValue === 0) {
                if (pIdx === 2 && !opsToShow.includes('+')) {
                    opsToShow.push('+');
                    hintText += " (ç‰¹æ¬Š+)";
                }
                if (pIdx === 3 && !opsToShow.includes('-')) {
                    opsToShow.push('-');
                    hintText += " (ç‰¹æ¬Š-)";
                }
            }

            // å»é™¤é‡è¤‡ä¸¦ç”ŸæˆæŒ‰éˆ•
            let uniqueOps = [...new Set(opsToShow)];
            const opOrder = ['+', '-', '*', '/'];
            uniqueOps.sort((a, b) => opOrder.indexOf(a) - opOrder.indexOf(b));

            uniqueOps.forEach((op, index) => {
                const btn = document.createElement('div');
                btn.textContent = op;
                btn.className = 'op-btn';

                // æ¨™è¨˜è‡ªç”±é¸çš„æŒ‰éˆ•æ¨£å¼
                if (frenzySubDiv && isSubDivTeam && (op === '-' || op === '/')) {
                    btn.classList.add('bonus-free');
                }

                // ä¿®æ­£ click handler å‚³éæ­£ç¢ºåƒæ•¸
                btn.onclick = () => selectOp(op, btn, frenzyAddMul);
                if (index === 0) {
                    selectOp(op, btn, frenzyAddMul);
                }
                btnContainer.appendChild(btn);
            });

            setTimeout(() => {
                const firstBtn = btnContainer.querySelector('.op-btn');
                if (firstBtn && !window.selectedOp) selectOp(uniqueOps[0], firstBtn, frenzyAddMul);
            }, 0);

            hintEl.textContent = hintText;
        }

        function selectOp(op, btnElement, frenzyAddMul) {
            window.selectedOp = op;

            document.querySelectorAll('.op-btn').forEach(b => {
                b.classList.remove('selected');
                b.classList.remove('bonus-double');
            });

            btnElement.classList.add('selected');

            // å¦‚æœæ˜¯åŠ ä¹˜æš´èµ°ä¸”é¸åˆ° +/*ï¼Œå‰‡æŒ‰éˆ•ç™¼å…‰
            if (frenzyAddMul && (op === '+' || op === '*')) {
                btnElement.classList.add('bonus-double');
            }
        }

        // --- æ“²éª°èˆ‡å‹•ç•« ---
        function startDiceAnimation() {
            const numInput = document.getElementById('player-num-input');
            const num = parseInt(numInput.value);
            if (isNaN(num) || num < 1 || num > 9) {
                alert("è«‹è¼¸å…¥ 1~9 çš„æ•´æ•¸");
                return;
            }

            if (usedNumbersInRound.includes(num)) {
                alert(`âš ï¸ æ•¸å­— ${num} é€™ä¸€è¼ªå·²ç¶“è¢«åˆ¥äººç”¨éäº†ï¼\nè«‹é¸æ“‡å…¶ä»–æ•¸å­—ã€‚`);
                numInput.value = "";
                return;
            }

            usedNumbersInRound.push(num);
            updateUsedNumsUI();

            // â˜… é›™éª°æ¢ä»¶ï¼šæš´èµ°é–‹å•Ÿ + é¸çš„æ˜¯ + æˆ– * (ç„¡CD)
            const op = window.selectedOp;
            const useDoubleDice = permanentBonusActive && (op === '+' || op === '*');

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = useDoubleDice ? "ğŸ²ğŸ² æš´èµ°é›™éª°..." : "ğŸ² æ“²éª°ä¸­...";

            const diceContainer = document.getElementById('dice-container');
            const dice1 = document.getElementById('dice-visual-1');
            const dice2 = document.getElementById('dice-visual-2');

            diceContainer.classList.remove('hidden');
            dice1.classList.add('rolling');
            dice1.classList.remove('dice-finished');

            if (useDoubleDice) {
                dice2.classList.remove('hidden');
                dice2.classList.add('rolling');
                dice2.classList.remove('dice-finished');
            } else {
                dice2.classList.add('hidden');
            }

            diceSound.currentTime = 0;
            diceSound.play().catch(e => { });

            let frames = 0;
            const totalFrames = 15;

            if (diceInterval) clearInterval(diceInterval);
            diceInterval = setInterval(() => {
                dice1.textContent = Math.floor(Math.random() * 6) + 1;
                if (useDoubleDice) {
                    dice2.textContent = Math.floor(Math.random() * 6) + 1;
                }
                frames++;
                if (frames >= totalFrames) {
                    clearInterval(diceInterval);
                    finishAnimation(num, submitBtn, dice1, dice2, useDoubleDice);
                }
            }, 80);
        }

        function finishAnimation(playerNum, submitBtn, dice1, dice2, useDoubleDice) {
            dice1.classList.remove('rolling');
            dice2.classList.remove('rolling');

            const op = window.selectedOp;
            let d1, d2, totalD, operand;

            while (true) {
                d1 = roll();
                if (useDoubleDice) {
                    d2 = roll();
                    totalD = d1 * d2; // â˜… ç›¸ä¹˜
                } else {
                    totalD = d1;
                }

                operand = playerNum * totalD;

                // é˜²å‘† /0
                if (op === '/' && operand === 0) {
                    continue;
                }
                break;
            }

            dice1.textContent = d1;
            dice1.classList.add('dice-finished');

            if (useDoubleDice) {
                dice2.textContent = d2;
                dice2.classList.add('dice-finished');
            }

            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = "æ“²éª°ä¸¦è¨ˆç®—";
                let displayDice2 = useDoubleDice ? d2 : null;
                processTurnLogic(playerNum, op, d1, displayDice2, totalD, operand, useDoubleDice);
            }, 800);
        }

        function processTurnLogic(num, op, d1, d2, totalD, operand, wasDouble) {
            const pName = currentTurn.playerName;

            let diceMsg;
            if (wasDouble) {
                diceMsg = `ğŸ²(${d1}x${d2}=${totalD})`;
            } else {
                diceMsg = `ğŸ²${totalD}`;
            }

            log(`${pName}: ${num} x ${diceMsg} = ${operand} (${op})`);

            expression += ` ${op} ${operand}`;

            try {
                currentValue = safeEval(expression);

                // --- è§¸åº•æ­¸é›¶æ©Ÿåˆ¶ ---
                if (currentValue < 0) {
                    currentValue = 0;
                    expression = "0";

                    document.getElementById('lcd-bg').style.backgroundColor = "#e74c3c";
                    setTimeout(() => {
                        document.getElementById('lcd-bg').style.backgroundColor = "";
                    }, 400);

                    if (!permanentBonusActive) {
                        permanentBonusActive = true;
                        showToast("ğŸ“‰ è§¸åº•æ­¸é›¶ï¼<br>ğŸ”¥ é™åˆ¶è§£é™¤ï¼šåŠ ä¹˜æ°¸ä¹…é›™éª°ï¼Œæ¸›é™¤å¶æ•¸è¼ªè‡ªç”±é¸ï¼");
                        log("<span style='color:#e74c3c; font-weight:bold'>ğŸ”¥ æš´èµ°é–‹å•Ÿï¼</span>");
                        // ç«‹å³æ›´æ–°ç‹€æ…‹
                        updateRoundHeader();
                    } else {
                        showToast("ğŸ“‰ è§¸åº•æ­¸é›¶ï¼");
                        log("âš ï¸ æ•¸å€¼ < 0ï¼Œå†æ¬¡æ­¸é›¶ï¼");
                    }
                }

            } catch (e) {
                log(`Err: ${e}`);
            }

            document.getElementById('expression-display').textContent = expression;
            const exprBox = document.getElementById('expression-display');
            exprBox.scrollLeft = exprBox.scrollWidth;

            document.getElementById('current-eval-lcd').textContent = Math.round(currentValue * 100) / 100;

            nextTurn();
        }

        function endGame() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');

            document.getElementById('final-expression').textContent = expression;
            document.getElementById('final-value').textContent = Math.round(currentValue * 100) / 100;

            const d_addmul = Math.abs(currentValue - target);
            const d_subdiv = Math.abs(currentValue);

            document.getElementById('diff-target').textContent = Math.round(d_addmul * 100) / 100;
            document.getElementById('diff-zero').textContent = Math.round(d_subdiv * 100) / 100;

            const winnerEl = document.getElementById('winner-announce');
            if (d_addmul < d_subdiv) {
                winnerEl.textContent = "ğŸ‰ åŠ ä¹˜éšŠç²å‹ï¼";
                winnerEl.style.color = "#ff6b6b";
            } else if (d_addmul > d_subdiv) {
                winnerEl.textContent = "ğŸ‰ æ¸›é™¤éšŠç²å‹ï¼";
                winnerEl.style.color = "#4e54c8";
            } else {
                winnerEl.textContent = "ğŸ¤ å¹³æ‰‹ï¼";
                winnerEl.style.color = "#333";
            }
        }
    </script>

</body>

</html>